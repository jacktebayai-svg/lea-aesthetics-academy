// packages/db/schema.prisma
// Master Aesthetics Suite - Complete Data Layer
// Multi-tenant SaaS for aesthetics clinics with LMS capabilities

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// CORE TENANT & USER MANAGEMENT
// ==========================================

model Tenant {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  plan             String   // starter, professional, enterprise
  status           String   @default("active") // active, suspended, cancelled
  domain           String?  @unique
  subdomain        String?  @unique
  settings         Json     @default("{}") // tenant-wide settings
  metadata         Json?    // custom metadata
  onboardedAt      DateTime?
  suspendedAt      DateTime?
  cancelledAt      DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  userRoles        UserRole[]
  brands           Brand[]
  locations        Location[]
  services         Service[]
  practitioners    Practitioner[]
  clients          Client[]
  appointments     Appointment[]
  payments         Payment[]
  templates        Template[]
  documents        Document[]
  events           Event[]
  campaigns        Campaign[]
  messages         Message[]
  subscriptions    Subscription[]
  invoices         Invoice[]
  files            File[]
  courses          Course[]
  policies         TenantPolicy[]
  automations      Automation[]
  notificationTemplates NotificationTemplate[]
  availabilityRules AvailabilityRule[]
  appointmentHolds AppointmentHold[]
  resourceConstraints ResourceConstraint[]
  searchIndexes    SearchIndex[]
  aiGenerations    AIGeneration[]
  auditLogs        AuditLog[]
  
  @@index([slug])
  @@index([status])
  @@map("tenants")
}

model User {
  id             String     @id @default(cuid())
  email          String     @unique
  password       String?    // For development/demo only
  authId         String?    @unique // External auth provider ID
  authProviderId String?    // auth0, clerk, etc.
  firstName      String?
  lastName       String?
  phone          String?
  avatar         String?    // S3 URL
  isActive       Boolean    @default(true)
  emailVerified  Boolean    @default(false)
  phoneVerified  Boolean    @default(false)
  lastLoginAt    DateTime?
  lastLoginIp    String?
  preferences    Json       @default("{}") // UI preferences, notifications settings
  metadata       Json?      // Custom user metadata
  deletedAt      DateTime?  // Soft delete for GDPR
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  
  // Relations
  roles          UserRole[]
  practitioner   Practitioner?
  refreshTokens  RefreshToken[]
  client         Client?
  createdDocuments Document[] @relation("DocumentCreator")
  createdEvents  Event[] @relation("EventActor")
  uploadedFiles  File[] @relation("FileUploader")
  
  // Learning Management System Relations
  enrollments    Enrollment[]
  assessmentAttempts AssessmentAttempt[]
  certificates   Certificate[]
  
  @@index([email])
  @@index([authId])
  @@index([isActive])
  @@map("users")
}

enum Role {
  OWNER
  MANAGER
  PRACTITIONER
  FRONTDESK
  FINANCE
  SUPPORT
  CLIENT
}

model UserRole {
  id         String   @id @default(cuid())
  userId     String
  tenantId   String
  role       Role
  locationId String?  // Optional location-specific role
  permissions Json?   // Override permissions for this role
  expiresAt  DateTime? // Temporary role assignment
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  createdBy  String?  // User ID who assigned this role
  
  // Relations
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location   Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  
  @@unique([userId, tenantId, role, locationId])
  @@index([tenantId, userId])
  @@index([tenantId, role])
  @@map("user_roles")
}

// ==========================================
// BRANDING & LOCATIONS
// ==========================================

model Brand {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  domain      String?  @unique
  subdomain   String?  @unique
  logoUrl     String?
  faviconUrl  String?
  theme       Json     // Complete theme configuration
  seo         Json?    // SEO metadata
  socialLinks Json?    // Social media URLs
  customCss   String?  @db.Text
  customJs    String?  @db.Text
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([domain])
  @@index([subdomain])
  @@map("brands")
}

model Location {
  id             String   @id @default(cuid())
  tenantId       String
  name           String
  slug           String
  type           String   @default("clinic") // clinic, studio, mobile
  timezone       String
  address        Json     // {line1, line2, city, state, postcode, country}
  coordinates    Json?    // {lat, lng} for map display
  phone          String?
  email          String?
  businessHours  Json     // Weekly schedule
  holidays       Json?    // Exception dates
  settings       Json     // Location-specific settings
  amenities      String[] // parking, wheelchair-access, etc.
  images         Json?    // Gallery URLs
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles      UserRole[]
  appointments   Appointment[]
  availabilityRules AvailabilityRule[]
  resourceConstraints ResourceConstraint[]
  
  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("locations")
}

// ==========================================
// SERVICES & PRACTITIONERS
// ==========================================

model Service {
  id               String   @id @default(cuid())
  tenantId         String
  name             String
  slug             String
  description      String?  @db.Text
  shortDescription String?
  basePrice        Int      // Price in cents
  durationMin      Int      // Service duration in minutes
  category         String   // injectables, laser, facial, etc.
  subcategory      String?
  buffers          Json?    // {before: 15, after: 10} in minutes
  requirements     Json?    // {consultation: true, patchTest: true}
  contraindications Json?   // Medical contraindications
  aftercare        Json?    // Aftercare instructions
  images           Json?    // Service images
  tags             String[] // searchable tags
  metadata         Json?    // Custom metadata
  displayOrder     Int      @default(0)
  isBookable       Boolean  @default(true)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments     Appointment[]
  practitionerServices PractitionerService[]
  
  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([tenantId, category])
  @@index([tenantId, isActive, isBookable])
  @@map("services")
}

model Practitioner {
  id                String   @id @default(cuid())
  tenantId          String
  userId            String   @unique
  title             String?  // Dr., RN, etc.
  bio               String?  @db.Text
  specialties       String[] // Array of specialty areas
  qualifications    Json?    // {degrees: [], certifications: []}
  registrationNum   String?  // Professional registration number
  availability      Json     // Default weekly availability rules
  bookingBuffer     Int      @default(15) // Minutes between appointments
  maxDailyBookings  Int?     // Optional daily booking limit
  profile           Json     // Additional profile data
  images            Json?    // Profile and gallery images
  isAcceptingNew    Boolean  @default(true)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments      Appointment[]
  services          PractitionerService[]
  availabilityRules AvailabilityRule[]
  
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("practitioners")
}

model PractitionerService {
  id             String   @id @default(cuid())
  practitionerId String
  serviceId      String
  customPrice    Int?     // Override base price for this practitioner
  customDuration Int?     // Override duration for this practitioner
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  
  // Relations
  practitioner   Practitioner @relation(fields: [practitionerId], references: [id], onDelete: Cascade)
  service        Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  @@unique([practitionerId, serviceId])
  @@map("practitioner_services")
}

// ==========================================
// CLIENT MANAGEMENT
// ==========================================

model Client {
  id               String   @id @default(cuid())
  tenantId         String
  userId           String?  @unique // Optional link to user account
  externalId       String?  // External system ID
  firstName        String
  lastName         String
  email            String
  phone            String?
  dateOfBirth      DateTime?
  gender           String?
  address          Json?    // {line1, line2, city, postcode, country}
  emergencyContact Json?    // {name, phone, relationship}
  preferences      Json?    // Communication preferences, etc.
  tags             String[] // Client tags for segmentation
  source           String?  // Acquisition source
  referredBy       String?  // Referral client ID
  notes            String?  @db.Text
  marketingConsent Boolean  @default(false)
  smsConsent       Boolean  @default(false)
  emailConsent     Boolean  @default(false)
  isVip            Boolean  @default(false)
  isBlacklisted    Boolean  @default(false)
  blacklistReason  String?
  firstVisitDate   DateTime?
  lastVisitDate    DateTime?
  totalSpent      Int      @default(0) // In cents
  visitCount       Int      @default(0)
  metadata         Json?    // Custom metadata
  deletedAt        DateTime? // Soft delete for GDPR
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdBy        String?  // User ID who created the record
  
  // Relations
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user             User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  medicalHistories MedicalHistory[]
  appointments     Appointment[]
  documents        Document[]
  esignSessions    EsignSession[]
  
  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([tenantId, email])
  @@index([tenantId, phone])
  @@index([tenantId, isBlacklisted])
  @@map("clients")
}

model MedicalHistory {
  id              String   @id @default(cuid())
  clientId        String
  version         Int
  allergies       Json?    // Known allergies
  medications     Json?    // Current medications
  conditions      Json?    // Medical conditions
  previousTreatments Json? // Previous aesthetic treatments
  skinType        String?  // Fitzpatrick scale
  pregnancyStatus String?  // Not pregnant, pregnant, breastfeeding
  smokingStatus   String?  // Never, former, current
  alcoholUse      String?  // None, social, regular
  supplements     Json?    // Vitamins and supplements
  familyHistory   Json?    // Relevant family medical history
  notes           String?  @db.Text
  riskFlags       Json?    // AI-generated risk flags
  reviewedBy      String?  // Practitioner who reviewed
  reviewedAt      DateTime?
  isActive        Boolean  @default(true) // Latest version flag
  createdAt       DateTime @default(now())
  createdBy       String?  // User ID who created the record
  
  // Relations
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@index([clientId, isActive])
  @@index([clientId, version])
  @@map("medical_histories")
}

enum AppointmentStatus {
  PENDING_DEPOSIT
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ==========================================
// APPOINTMENTS & SCHEDULING
// ==========================================

model Appointment {
  id                String            @id @default(cuid())
  tenantId          String
  clientId          String
  practitionerId    String
  serviceId         String
  locationId        String
  startTs           DateTime
  endTs             DateTime
  status            AppointmentStatus
  confirmationCode  String?           @unique
  roomId            String?           // Resource constraint
  equipmentIds      String[]          // Equipment requirements
  notes             String?           @db.Text
  internalNotes     String?           @db.Text // Staff-only notes
  remindersSent     Json?             // {"24h": true, "1h": false}
  checkedInAt       DateTime?
  completedAt       DateTime?
  cancelledAt       DateTime?
  cancelledBy       String?           // User ID
  cancellationReason String?
  noShowReason      String?
  policyVersion     Int               // Version of policy applied
  source            String?           // online, phone, walk-in
  metadata          Json?             // Custom metadata
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  createdBy         String?           // User ID who created
  
  // Relations
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client            Client            @relation(fields: [clientId], references: [id], onDelete: Restrict)
  practitioner      Practitioner      @relation(fields: [practitionerId], references: [id], onDelete: Restrict)
  service           Service           @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  location          Location          @relation(fields: [locationId], references: [id], onDelete: Restrict)
  payments          Payment[]
  documents         Document[]
  holds             AppointmentHold[]
  
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, startTs])
  @@index([tenantId, clientId])
  @@index([tenantId, practitionerId])
  @@index([confirmationCode])
  @@map("appointments")
}

model AppointmentHold {
  id            String   @id @default(cuid())
  tenantId      String
  appointmentId String?
  userId        String?  // User holding the slot
  sessionId     String   // Browser session
  startTs       DateTime
  endTs         DateTime
  serviceId     String
  practitionerId String
  locationId    String
  expiresAt     DateTime // Hold expiration
  convertedAt   DateTime? // When converted to appointment
  releasedAt    DateTime? // When manually released
  createdAt     DateTime @default(now())
  
  // Relations
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  
  @@index([tenantId, expiresAt])
  @@index([sessionId])
  @@map("appointment_holds")
}

enum PaymentStatus {
  REQUIRES_ACTION
  SUCCEEDED
  FAILED
  REFUNDED
  PARTIAL_REFUND
}

// ==========================================
// PAYMENTS & FINANCIAL
// ==========================================

model Payment {
  id                String        @id @default(cuid())
  tenantId          String
  appointmentId     String?
  clientId          String?
  type              String        // deposit, full, refund, adjustment
  stripePiId        String?       @unique // Payment Intent ID
  stripeChargeId    String?       @unique
  stripeRefundId    String?       @unique
  amountCents       Int
  currency          String        @default("gbp")
  status            PaymentStatus
  depositCents      Int           @default(0)
  refundedCents     Int           @default(0)
  processingFee     Int           @default(0) // Stripe fees in cents
  netAmount         Int           @default(0) // After fees
  paymentMethod     String?       // card, cash, transfer
  last4             String?       // Last 4 digits of card
  cardBrand         String?       // visa, mastercard, etc.
  receiptUrl        String?       // Stripe receipt URL
  failureReason     String?
  failureCode       String?
  refundReason      String?
  metadata          Json?         // Custom metadata
  idempotencyKey    String?       @unique
  processedAt       DateTime?
  settledAt         DateTime?    // When funds were settled
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  createdBy         String?       // User ID who created
  
  // Relations
  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointment       Appointment?  @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, appointmentId])
  @@index([stripePiId])
  @@map("payments")
}

// ==========================================
// DOCUMENTS & TEMPLATES
// ==========================================

model Template {
  id               String   @id @default(cuid())
  tenantId         String?  // null → global
  name             String
  type             String   // consent, aftercare, policy, intake
  jurisdiction     String   // UK, EU, US
  version          String
  content          Json     // blocks with placeholders
  mandatoryBlocks  String[] // IDs of required blocks
  placeholders     String[] // Available placeholders
  validationRules  Json?    // Validation rules for fields
  effectiveFrom    DateTime
  effectiveTo      DateTime?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdBy        String?  // User ID who created
  
  // Relations
  tenant           Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documents        Document[]
  
  @@index([tenantId, type])
  @@index([type, jurisdiction, effectiveFrom])
  @@map("templates")
}

model Document {
  id               String    @id @default(cuid())
  tenantId         String
  templateId       String?
  appointmentId    String?
  clientId         String?
  type             String    // consent, aftercare, policy, invoice
  title            String
  content          Json      // Rendered document content
  version          String
  locked           Boolean   @default(false)
  signedAt         DateTime?
  signedBy         String?   // User ID who signed
  signatureData    Json?     // Signature metadata (IP, UA, etc.)
  expiresAt        DateTime?
  stampHash        String?   // Cryptographic stamp
  s3Key            String?   // S3 location for PDF
  metadata         Json?     // Custom metadata
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  createdBy        String?   // User ID who created
  
  // Relations
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template         Template? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  appointment      Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  client           Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  creator          User?     @relation("DocumentCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  esignSessions    EsignSession[]
  
  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, clientId])
  @@index([tenantId, appointmentId])
  @@map("documents")
}

model EsignSession {
  id               String   @id @default(cuid())
  documentId       String
  clientId         String
  provider         String   @default("internal") // internal, docusign, hellosign
  envelopeId       String?  @unique // External provider envelope ID
  status           String   // created, sent, viewed, signed, declined, void
  envelope         Json     // Envelope data
  sentAt           DateTime?
  viewedAt         DateTime?
  signedAt         DateTime?
  declinedAt       DateTime?
  declineReason    String?
  voidedAt         DateTime?
  voidReason       String?
  reminderCount    Int      @default(0)
  lastReminderAt   DateTime?
  ipAddress        String?  // Signer's IP
  userAgent        String?  // Signer's browser
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  document         Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@index([documentId])
  @@index([clientId])
  @@index([status])
  @@map("esign_sessions")
}

// ==========================================
// EVENTS & AUDIT
// ==========================================

model Event {
  id           String   @id @default(cuid())
  tenantId     String
  actorId      String?  // User who triggered the event
  type         String   // booking.created, payment.succeeded, etc.
  entityType   String?  // appointment, payment, client, etc.
  entityId     String?  // ID of the affected entity
  payload      Json     // Event data
  metadata     Json?    // Additional context (IP, user agent, etc.)
  occurredAt   DateTime @default(now())
  processedAt  DateTime? // When processed by workers
  
  // Relations
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor        User?    @relation("EventActor", fields: [actorId], references: [id], onDelete: SetNull)
  
  @@index([tenantId, type])
  @@index([tenantId, occurredAt])
  @@index([tenantId, entityType, entityId])
  @@map("events")
}

model AuditLog {
  id           String   @id @default(cuid())
  tenantId     String
  userId       String?  // User who performed the action
  action       String   // create, update, delete, view
  entityType   String   // Model name
  entityId     String   // Entity ID
  changes      Json?    // Before/after values for updates
  ipAddress    String?
  userAgent    String?
  sessionId    String?
  createdAt    DateTime @default(now())
  
  // Relations
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, entityType, entityId])
  @@index([tenantId, userId])
  @@index([tenantId, createdAt])
  @@map("audit_logs")
}

// ==========================================
// MARKETING & COMMUNICATIONS
// ==========================================

model Campaign {
  id              String    @id @default(cuid())
  tenantId        String
  name            String
  type            String    // email, sms, multi-channel
  audience        Json      // Segment criteria
  content         Json      // Campaign content by channel
  scheduleTs      DateTime?
  startedAt       DateTime?
  completedAt     DateTime?
  status          String    // draft, scheduled, running, paused, completed, cancelled
  stats           Json?     // {sent: 0, delivered: 0, opened: 0, clicked: 0}
  abTestVariants  Json?     // A/B test configuration
  metadata        Json?     // Custom metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String?   // User ID who created
  
  // Relations
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages        Message[]
  
  @@index([tenantId])
  @@index([tenantId, status])
  @@map("campaigns")
}

model Message {
  id              String   @id @default(cuid())
  tenantId        String
  campaignId      String?
  channel         String   // email, sms, whatsapp, push
  toRef           String   // email address, phone number, etc.
  clientId        String?  // Link to client
  templateId      String?  // Notification template used
  subject         String?
  payload         Json     // Message content and variables
  status          String   // queued, sending, sent, delivered, failed, bounced
  provider        String?  // sendgrid, twilio, etc.
  providerMsgId   String?  // External provider message ID
  sentAt          DateTime?
  deliveredAt     DateTime?
  openedAt        DateTime?
  clickedAt       DateTime?
  bouncedAt       DateTime?
  error           String?  @db.Text
  errorCode       String?
  retryCount      Int      @default(0)
  metadata        Json?    // Custom metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  campaign        Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, channel])
  @@index([campaignId])
  @@map("messages")
}

model NotificationTemplate {
  id              String   @id @default(cuid())
  tenantId        String?
  name            String
  slug            String
  channel         String   // email, sms, whatsapp
  trigger         String?  // Event type that triggers this
  subject         String?  // Email subject template
  content         String   @db.Text // Template content
  variables       String[] // Required variables
  metadata        Json?    // Custom metadata
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  tenant          Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, slug])
  @@index([tenantId, channel])
  @@map("notification_templates")
}

model Automation {
  id              String   @id @default(cuid())
  tenantId        String
  name            String
  description     String?
  trigger         Json     // Event trigger configuration
  conditions      Json?    // Conditions to evaluate
  actions         Json     // Actions to perform
  schedule        Json?    // Cron schedule if time-based
  isActive        Boolean  @default(true)
  lastRunAt       DateTime?
  runCount        Int      @default(0)
  errorCount      Int      @default(0)
  metadata        Json?    // Custom metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?  // User ID who created
  
  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("automations")
}

// ==========================================
// AUTHENTICATION & SUBSCRIPTIONS
// ==========================================

model RefreshToken {
  id            String   @id @default(cuid())
  userId        String
  token         String   @unique
  family        String?  // Token family for rotation
  expiresAt     DateTime
  lastUsedAt    DateTime?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
  
  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([family])
  @@map("refresh_tokens")
}

model Subscription {
  id                    String   @id @default(cuid())
  tenantId              String
  stripeSubId           String?  @unique
  stripeCustId          String?
  status                String   // active, trialing, past_due, canceled, unpaid
  plan                  String   // starter, professional, enterprise
  planDetails           Json     // Full plan configuration
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  trialStart            DateTime?
  trialEnd              DateTime?
  cancelAtPeriodEnd     Boolean  @default(false)
  canceledAt            DateTime?
  endedAt               DateTime?
  metadata              Json?    // Custom metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  tenant                Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices              Invoice[]
  
  @@index([tenantId])
  @@index([status])
  @@map("subscriptions")
}

model Invoice {
  id                String   @id @default(cuid())
  tenantId          String
  subscriptionId    String?
  stripeInvId       String?  @unique
  invoiceNumber     String?  @unique
  amountCents       Int
  taxCents          Int      @default(0)
  discountCents     Int      @default(0)
  currency          String   @default("gbp")
  status            String   // draft, open, paid, void, uncollectible
  dueDate           DateTime?
  paidAt            DateTime?
  attemptCount      Int      @default(0)
  nextPaymentAttempt DateTime?
  hostedInvoiceUrl  String?  // Stripe hosted invoice URL
  invoicePdf        String?  // S3 URL for PDF
  metadata          Json?    // Custom metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription      Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  
  @@index([tenantId])
  @@index([subscriptionId])
  @@index([status])
  @@map("invoices")
}

// ==========================================
// FILE STORAGE
// ==========================================

model File {
  id            String   @id @default(cuid())
  tenantId      String?
  filename      String
  originalName  String
  mimetype      String
  size          Int      // Size in bytes
  s3Key         String   @unique
  s3Bucket      String
  s3Region      String   @default("eu-west-2")
  cdnUrl        String?  // CloudFront URL
  uploadedBy    String?  // User ID
  entityType    String?  // appointment, client, etc.
  entityId      String?  // Related entity ID
  category      String?  // document, image, video
  isPublic      Boolean  @default(false)
  metadata      Json?    // Image dimensions, duration, etc.
  createdAt     DateTime @default(now())
  
  // Relations
  tenant        Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  uploader      User?    @relation("FileUploader", fields: [uploadedBy], references: [id], onDelete: SetNull)
  
  @@index([tenantId])
  @@index([entityType, entityId])
  @@map("files")
}

// ==========================================
// SEARCH & AI
// ==========================================

model SearchIndex {
  id            String   @id @default(cuid())
  tenantId      String
  indexName     String   // clients, appointments, services
  entityType    String   // Model name
  entityId      String   // Entity ID
  content       Json     // Indexed content
  searchableText String  @db.Text // Concatenated searchable text
  metadata      Json?    // Additional metadata for filtering
  version       Int      @default(1)
  indexedAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, entityType, entityId])
  @@index([tenantId, indexName])
  @@index([tenantId, entityType])
  @@map("search_indexes")
}

model AIGeneration {
  id            String   @id @default(cuid())
  tenantId      String
  type          String   // copy, pricing, risk, document
  promptVersion String   // v2025.01.15
  model         String   // gpt-4, claude-3
  input         Json     // Input data
  output        Json     // Generated content
  validation    Json?    // Schema validation results
  guardrails    Json?    // Applied guardrails
  tokenCount    Int?     // Tokens used
  latencyMs     Int?     // Response time
  cost          Float?   // Cost in dollars
  status        String   // success, failed, rejected
  error         String?  @db.Text
  metadata      Json?    // Additional context
  createdAt     DateTime @default(now())
  createdBy     String?  // User ID who triggered
  
  // Relations
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, type])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("ai_generations")
}

// ==========================================
// BOOKING ENGINE
// ==========================================

model AvailabilityRule {
  id              String   @id @default(cuid())
  tenantId        String
  practitionerId  String?
  locationId      String?
  type            String   // weekly, exception, block
  priority        Int      @default(0) // Higher priority overrides
  startDate       DateTime?
  endDate         DateTime?
  recurrence      Json?    // RRULE for recurring patterns
  timeSlots       Json     // Available time slots
  reason          String?  // For blocks/exceptions
  metadata        Json?    // Additional data
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?  // User ID who created
  
  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  practitioner    Practitioner? @relation(fields: [practitionerId], references: [id], onDelete: Cascade)
  location        Location? @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([tenantId, practitionerId])
  @@index([tenantId, locationId])
  @@index([tenantId, type, isActive])
  @@map("availability_rules")
}

model ResourceConstraint {
  id              String   @id @default(cuid())
  tenantId        String
  locationId      String
  type            String   // room, equipment, staff
  resourceId      String   // ID of the resource
  name            String
  capacity        Int      @default(1) // How many can use simultaneously
  schedule        Json?    // Available hours
  requirements    Json?    // Services that require this resource
  maintenanceSchedule Json? // Maintenance windows
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location        Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, locationId])
  @@index([tenantId, type])
  @@map("resource_constraints")
}

// ==========================================
// POLICIES & CONFIGURATION
// ==========================================

model TenantPolicy {
  id              String   @id @default(cuid())
  tenantId        String
  type            String   // deposit, cancellation, noShow, booking
  name            String
  version         Int      @default(1)
  rules           Json     // Policy rules
  effectiveFrom   DateTime
  effectiveTo     DateTime?
  isDefault       Boolean  @default(false)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?  // User ID who created
  
  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, type, version])
  @@index([tenantId, type])
  @@index([tenantId, isActive, isDefault])
  @@map("tenant_policies")
}

// ==========================================
// LEARNING MANAGEMENT SYSTEM
// ==========================================

model Course {
  id              String   @id @default(cuid())
  tenantId        String?  // null for global courses
  title           String
  slug            String   @unique
  description     String?  @db.Text
  level           String   // Level 2, Level 3, Level 4
  category        String   // Anatomy, Safety, Treatments, Business
  subcategory     String?
  prerequisites   String[] // Course IDs that must be completed first
  duration        Int      // Estimated hours
  credits         Int?     // CPD credits
  price           Int?     // Price in cents if paid course
  content         Json     // Course structure and content
  coverImage      String?  // S3 URL
  promotional     Json?    // Promotional content
  tags            String[] // Searchable tags
  accreditation   Json?    // Accreditation details
  passingScore    Int      @default(70) // Overall passing percentage
  certificateTemplate String? // Certificate template ID
  isPublished     Boolean  @default(false)
  isActive        Boolean  @default(true)
  displayOrder    Int      @default(0)
  metadata        Json?    // Custom metadata
  publishedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?  // User ID who created
  
  // Relations
  tenant          Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  modules         Module[]
  enrollments     Enrollment[]
  certificates    Certificate[]
  
  @@index([tenantId])
  @@index([slug])
  @@index([level, category])
  @@index([isPublished, isActive])
  @@map("courses")
}

model Module {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  slug        String
  description String?
  content     Json     // Module content (text, videos, images)
  order       Int      @default(0)
  duration    Int      // estimated minutes
  isRequired  Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  course      Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]
  assessments Assessment[]
  
  @@map("modules")
}

model Lesson {
  id          String   @id @default(cuid())
  moduleId    String
  title       String
  slug        String
  content     Json     // Lesson content (markdown, media)
  type        String   // text, video, interactive, quiz
  order       Int      @default(0)
  duration    Int      // estimated minutes
  isRequired  Boolean  @default(true)
  resources   Json?    // Additional resources, downloads
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  module      Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress    LessonProgress[]
  
  @@map("lessons")
}

model Assessment {
  id              String   @id @default(cuid())
  moduleId        String
  courseId        String?
  title           String
  description     String?
  type            String   // quiz, exam, practical, assignment
  questions       Json     // Assessment questions
  passingScore    Int      @default(70)
  timeLimit       Int?     // minutes
  maxAttempts     Int      @default(3)
  isRequired      Boolean  @default(true)
  order           Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  module          Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  attempts        AssessmentAttempt[]
  
  @@map("assessments")
}

model Enrollment {
  id              String   @id @default(cuid())
  userId          String
  courseId        String
  status          String   // enrolled, in_progress, completed, dropped
  progress        Int      @default(0) // percentage
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  certificateUrl  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  course          Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessonProgress  LessonProgress[]
  
  @@unique([userId, courseId])
  @@map("enrollments")
}

model LessonProgress {
  id           String   @id @default(cuid())
  enrollmentId String
  lessonId     String
  status       String   // not_started, in_progress, completed
  progress     Int      @default(0) // percentage
  timeSpent    Int      @default(0) // minutes
  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson       Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@unique([enrollmentId, lessonId])
  @@map("lesson_progress")
}

model AssessmentAttempt {
  id           String   @id @default(cuid())
  assessmentId String
  userId       String
  answers      Json     // User's answers
  score        Int      // achieved score
  totalScore   Int      // maximum possible score
  passed       Boolean  @default(false)
  timeSpent    Int      // minutes
  startedAt    DateTime @default(now())
  completedAt  DateTime?
  feedback     Json?    // Detailed feedback per question
  
  // Relations
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  user         User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("assessment_attempts")
}

model Certificate {
  id           String   @id @default(cuid())
  userId       String
  courseId     String
  certificateNumber String @unique
  issuedAt     DateTime @default(now())
  expiresAt    DateTime?
  pdfUrl       String?
  metadata     Json?    // Additional certificate data
  
  // Relations
  user         User @relation(fields: [userId], references: [id], onDelete: Cascade)
  course       Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@map("certificates")
}
